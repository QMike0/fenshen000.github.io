---
title: 卡尔曼滤波
updated: '2023-08-09'
excerpt: ''
permalink: /post/carman-filter-tjop1.html
comments: true
toc: true
---

---
title: 卡尔曼滤波
date: 2023-07-27T10:53:59Z
lastmod: 2023-08-06T23:16:20Z
---

# 基础内容

* 适用系统：线性高斯系统

  其中，**线性**指满足叠加性$y=y_1+y_2=ax_1+bx_2$​和齐次性$k_y=k_x$，**高斯指噪声满足正态分布**
* 宏观意义：*滤波*即是给不同量以不同的加权值。

  为滤除噪声，理想状态是$信号\times1+噪声\times0$​

  卡尔曼滤波则是$估计值\times权值_1+观测值\times权值_2$，从而得到最佳修正值。

  类似地，低通滤波器是$低频信号\times1+高频信号\left(噪声\right)\times0$​

## 引入**状态空间表达式**

* 离散线性动态系统模型：

$$
\left\{\begin{aligned} & 状态方程:x_{k}=Ax_{k-1}+Bu_{k}+\omega_{k}\\\\  & 观测方程:y_{k}=Hx_{k}+\nu_{k}\end{aligned}\right.
$$

* 其中，$x$表示状态量*（系统状态矩阵）*，$y$表示观测量*（系统状态矩阵的观测值）*。

  状态方程中，

  $x_k$：当前时刻的状态值

  $x_{k-1}$：上一时刻该状态的值

  $u_k$：给到$x_k$的输入

  $\omega_k$：过程噪声

  $A$：状态转移矩阵

  $B$：控制矩阵

  > 对于大多数实际的控制系统（如倒立摆系统）而言，它并不是一个严格的线性时变系统，亦或系统结构参数的不确定性，导致估计的状态值$x_k$存在偏差，而这个偏差值由过程噪声$\omega_k$来表征。
  >

  观测方程中，

  $y_k$：要观测的量

  $\nu_k$：观测噪声，与观测器的误差有关

  $H$：状态观测矩阵

  > 采集的信号往往是包含噪声及干扰信号$\nu_{k}$的，亦或观测矩阵$H$自身的观测偏差，从而导致测得的实际信号（观测值）与真实值之间存在一定的偏差。
  >

* 系统状态的方框图如下：*（假设权重A、B、H都是1）*

  ![image](assets/image-20230731104100-vkvvbo1.png)

  以[烧水](https://www.bilibili.com/video/BV1Rh41117MT/?p=3&amp;spm_id_from=pageDriver&amp;vd_source=8bba695aa4490252230ffd2e2cc0609b)为例，$x_k$指当前时刻的实际水温，$x_{k-1}$指上一时刻的实际水温，$u_k$指每个时间段外部加热带来的水温增长(即$\Delta T$)，$\omega_k$表示室温的变化等对水温的持续影响；$\nu_k$表示温度器的误差，$y_k$表示水温测量结果。

## 参数分析

* 噪声$\omega_k$和$\nu_k$符合****，都属于高斯白噪声：*(高斯白噪声：符合均值为零的高斯分布的噪声)*

  $$
  \left\{\begin{aligned} & 过程噪声:\omega_{k}\in N(0,Q_{k})\\  
  \\& 观测噪声:\nu_{k}\in N(0,R_{k})\end{aligned}\right.
  $$

> 其中，$Q_k$和$R_k$是噪声$\omega_k$和$\nu_k$的协方差。
>
> 状态量$x_k$受到噪声的影响，同样符合正态分布

* 二维状态下，状态量$x_k=\begin{bmatrix}x_{k1}\\x_{k2}\end{bmatrix}$是一个二维向量，$x_{k1}$和$x_{k2}$分别对应噪声$\omega_{k1}$和$\omega_{k2}$，进而状态量$x_k$的协方差为

$$
cov(x_{k1},x_{k2})=\begin{bmatrix}cov(x_1,x_1) & cov(x_1,x_2)\\ cov(x_2,x_1) & cov(x_2,x_2)\end{bmatrix}
$$

> 协方差相关公式：(其中$var$表示方差)
>
> $$
> \left\{\begin{aligned}
> &cov(X,Y)=cov(Y,X)\\
> &cov(aX,bY)=ab\times cov(X,Y)\\
> &cov(X_1+X_2,Y)=cov(X_1,Y)+cov(X_2,Y)\\
> &cov(X,X)=var(X)\\
> &cov(AX,AX)=Acov(X,X)A^T\\
> &cov(AX+K,AX+K)=Acov(X,X)A^T,其中K是常数
> \end{aligned}\right.
> $$

## 超参数分析

* **超参数**指过程噪声和观测噪声的方差$Q$和$R$
* 后续要对这两个超参数进行调参，*类似于PID控制中的P、I、D三个参数*

# 进阶内容

## 卡尔曼公式的理解

* 实现过程：使用上一次的最优估计结果预测当前的值，同时使用观测值修正当前值，得到最优估计结果。

  > * **预测当前值**：先验估计
  >
  > * **观测值**：传感器探测到的数据
  >
  > * **最优估计结果**：后验估计
  >

* 卡尔曼公式(推导过程见[卡尔曼滤波原理与公式推导](https://zhuanlan.zhihu.com/p/48876718))：

  * *预测方程*

  $$
  \left\{\begin{aligned} & \hat{x_{t}^{-}}=A\hat{x_{t-1}}+Bu_{t}\\  & P_{t}^{-}=AP_{t-1}A^{T}+Q\end{aligned}\right.
  $$

  其中，

  $\hat{x_{t}^{-}}$：当前预测值

  $\hat{x_{t-1}}$：上一次的最优估计值

  $P_{t-1}$：上一次最优估计值$\hat{x_{t-1}}$的协方差矩阵

  $P_t^-$：当前预测值$\hat{x_{t}^{-}}$的协方差矩阵

  > * 第一条公式是基于上一次的最优估计值（上一次的后验估计）预测当前值（先验估计）
  >
  > * 第二条公式是协方差公式，基于上一次最优估计值$\hat{x_{t-1}}$的协方差矩阵$P_{t-1}$计算出当前预测值$\hat{x_{t}^{-}}$的协方差矩阵$P_t^-$（先验估计的协方差）。$AP_{t-1}A^{T}$实际是计算$P_{t-1}$的协方差，可参考协方差相关公式[^1]的第五个公式。
  >
  >   第二条公式可以理解为：
  >
  >   $$
  >   \begin{aligned}P_{t}^{-} & =cov(\hat{x_{t}^{-}},\hat{x_{t}^{-}})\\  & =cov(A\hat{x_{t-1}}+Bu_{t}+\omega_{t},A\hat{x_{t-1}}+Bu_{t}+\omega_{t}),注：此时考虑\omega_{t}\\  & =cov(A\hat{x_{t-1}},A\hat{x_{t-1}})+cov(\omega_{t},\omega_{t})\\  & =Acov(\hat{x_{t-1}},\hat{x_{t-1}})A^{T}+Q\\  & =AP_{t-1}A^{T}+Q\end{aligned}
  >   $$
  >

  * *更新方程*

  $$
  \left\{\begin{aligned}
  &K_t=P_t^-H^T(HP^-_tH^T+R)^{-1}\\
  &\hat{x_t}=\hat{x_t^-}+K_t(y_t-H\hat{x_t^-})\\
  &P_t=(1-K_tH)P_t^-
  \end{aligned}\right.
  $$

  其中，

  $K_t$：卡尔曼增益

  $\hat{x_t}$：当前最优估计值

  $y_t$：当前实际观测值

  $P_t$：当前最优估计值$\hat{x_t}$的协方差矩阵

  > * 第一条公式用于计算**卡尔曼增益**​$K_t$（滤波增益矩阵，中间变量）
  >
  >   设$H$为单位矩阵，第一条公式进一步可推导为
  >
  >   $$
  >   \begin{aligned}
  >   K_{t} 
  >   & =\frac{P_{t}^{-}}{P_{t}^{-}+R}\\  
  >   & =\frac{AP_{t-1}A^{T}+Q}{AP_{t-1}A^{T}+Q+R}
  >   \end{aligned}
  >   $$
  >
  >   可见**卡尔曼增益**​$K_t$**​**与两个超参数**​$Q$**​**和**​$R$**​**都有关。**
  >
  > * 第二条公式用于修正估计以得到最终滤波结果，即计算最优估计。其中，$(y_t-H\hat{x_t^-})$**​**表示实际观测值和预测观测值的残差**，与卡尔曼增益$K_t$一起修正先验估计（预测值），得到后验估计（最优估计值）。
  >
  > * 第三条公式用于计算最优估计值$\hat{x_t}$的协方差矩阵$P_t$（后验估计的协方差）
  >
  > * **注：**​$P_t$**​**和**​$P_t^-$**​**、**​$\hat{x_t}$**​**和**​$\hat{x_t^-}$**​**并非互为倒数的关系，表示先验和后验两类完全不同的量。**
  >
* 简单卡尔曼滤波就是根据上一次的最优估计和相应的协方差，得到本次的预测值和对应协方差，再进行修正得到本次的最优估计和相应协方差，然后进一步得到下一次的预测值，如此循环往复，迭代得到最终的最优估计值。

## 调节超参数和初始化参数

### $Q$与$R$的取值

（1）公式层面理解

对于卡尔曼公式

$$
\left\{\begin{aligned}
&P_{t}^{-}=AP_{t-1}A^{T}+Q\\
&K_{t}=P_{t}^{-}H^{T}(HP_{t}^{-}H^{T}+R)^{-1}
\end{aligned}\right.
$$

取$A$和$H$为单位矩阵，可得$K_t$化简结果为

$$
K_t=\frac{P_{t-1}+Q}{P_{t-1}^{-}+Q+R}
$$

结合计算最优估计值的公式$\hat{x_{t}}=\hat{x_{t}^{-}}+K_{t}(z_{t}-H\hat{x_{t}^{-}})$，对$Q$和$R$的取值进行分析。

* 当更信任卡尔曼增益$K_t$​*（例如信任观测值）*时，应增加该权重，即增大$K_t$，此时若观测器精度足够高，观测误差较小，应减少$R$以增大$K_t$
* 当构建的运动模型理想、过程误差较少时，预测值就越靠近最优估计值，此时考虑减少$K_t$的权重，即增大$R$或减小$Q$

（2）从其他方面理解

* 分析$Q$

  $Q$本质上是过程噪声的方差，若运动模型基本没有过程噪声*（如一个物体基本能保持匀速或匀加速运动），*此时$Q$可以取小一点的值。相反地，$Q$就需要调大些。
* 分析$R$

  $R$是观测噪声的方差，若观测器精度高误差小，则$R$取小点的值，反之调大。

### $P_0$与$\hat{x_0}$的取值

* 一般地，取$\hat{x_0}=0$，$P_0$往小取值，便于收敛

  > $P_0$一般取1，不可取0
  >

## 卡尔曼滤波的使用

* 选择状态量、观测量
* 构建运动模型，搭建状态空间方程
* 初始化参数$Q$、$R$、$P_0$、$\hat{x_0}$
* 代入卡尔曼滤波公式迭代，迭代过程如下：

![image](assets/image-20230806224010-le04nrg.png)

* 调节超参数$Q$、$R$

# 高阶内容

参考[该视频](https://www.bilibili.com/video/BV1Rh41117MT?p=5&amp;spm_id_from=pageDriver&amp;vd_source=8bba695aa4490252230ffd2e2cc0609b)中给出的例子，深入理解卡尔曼滤波的应用。

‍

[^1]: > 协方差相关公式：(其中$var$表示方差)
    >
    > $$
    > \left\{\begin{aligned}
    > &cov(X,Y)=cov(Y,X)\\
    > &cov(aX,bY)=ab\times cov(X,Y)\\
    > &cov(X_1+X_2,Y)=cov(X_1,Y)+cov(X_2,Y)\\
    > &cov(X,X)=var(X)\\
    > &cov(AX,AX)=Acov(X,X)A^T\\
    > &cov(AX+K,AX+K)=Acov(X,X)A^T,其中K是常数
    > \end{aligned}\right.
    > $$
    >
